from bblean.bitbirch import BitBirch
from bblean.fingerprints import make_fake_fingerprints
from inline_snapshot import snapshot


def test_random_fps_consistency() -> None:
    fps = make_fake_fingerprints(
        3000, n_features=2048, seed=12620509540149709235, pack=True
    )
    tree = BitBirch(branching_factor=50, threshold=0.65, merge_criterion="diameter")
    tree.fit(fps, n_features=2048)
    output_cent = tree.get_centroids()
    output_med = tree.get_medoids(fps)
    assert [c.tolist()[:5] for c in output_cent[:5]] == snapshot(
        [
            [255, 255, 255, 255, 255],
            [255, 255, 255, 255, 255],
            [255, 255, 253, 255, 255],
            [255, 255, 255, 255, 255],
            [255, 255, 255, 255, 255],
        ]
    )
    assert output_med[:5, :5].tolist() == snapshot(
        [
            [239, 247, 247, 255, 214],
            [255, 255, 255, 255, 191],
            [255, 159, 223, 255, 219],
            [255, 255, 255, 255, 255],
            [255, 255, 255, 255, 255],
        ]
    )
    tree.global_clustering(20, method="kmeans", random_state=42)
    output_mol_ids = tree.get_cluster_mol_ids(global_clusters=True)
    output_med = tree.get_medoids(fps, global_clusters=True)
    assert output_mol_ids[:5] == snapshot(
        [
            [
                2320,
                2272,
                2862,
                2501,
                2076,
                2152,
                2168,
                1625,
                1451,
                1239,
                1317,
                627,
                819,
                119,
            ],
            [
                2957,
                2738,
                2811,
                2617,
                1994,
                1522,
                1683,
                1638,
                1671,
                1113,
                1352,
                808,
                261,
                165,
                416,
                245,
            ],
            [
                1786,
                1803,
                1818,
                1839,
                1920,
                1923,
                1944,
                1824,
                1841,
                1866,
                1886,
                1893,
                1895,
                1911,
                1922,
                1935,
                1939,
                1953,
                1956,
                1961,
                1963,
                1973,
                2171,
                2187,
                2188,
                2219,
                2235,
                2292,
                2297,
                2298,
                2313,
                2314,
                2176,
                2185,
                2339,
                1942,
                2202,
                2247,
                2248,
                2271,
                2318,
                2326,
                2328,
                2341,
                2343,
                2630,
                2633,
                2638,
                2643,
                2648,
                2655,
                2657,
                2664,
                2668,
                2670,
                2662,
                2704,
                2718,
                2808,
                2837,
                2767,
                2817,
                2853,
                2856,
                2858,
                2868,
                2873,
                2877,
                2825,
                2918,
                2929,
                2875,
                2891,
                2903,
                2908,
                2911,
                2942,
                2961,
                2658,
                2841,
                2909,
                2933,
                2940,
                2867,
                2882,
                2934,
                2956,
                2977,
                2982,
                2999,
                2644,
                2750,
                2930,
                2932,
                2851,
                2874,
                2894,
                2902,
                2921,
                2922,
                2673,
                2734,
                2819,
                2833,
                2850,
                2855,
                2871,
                2840,
                2674,
                2758,
                2760,
                2821,
                2656,
                2805,
                2797,
                2798,
                2770,
                2772,
                2778,
                2779,
                2780,
                2781,
                2783,
                2784,
                2785,
                2787,
                2792,
                2628,
                2652,
                2717,
                2725,
                2743,
                2749,
                2676,
                2699,
                2689,
                2649,
                2678,
                2319,
                2012,
                2177,
                2256,
                2384,
                2363,
                2370,
                2393,
                2404,
                2419,
                2615,
                2344,
                2347,
                2403,
                2409,
                2412,
                2414,
                2430,
                2438,
                2254,
                2398,
                2399,
                2441,
                2436,
                2446,
                2447,
                2468,
                2471,
                2492,
                2364,
                2374,
                2502,
                2503,
                2572,
                2516,
                2519,
                2577,
                2600,
                2480,
                2487,
                2546,
                2568,
                2580,
                2584,
                2591,
                2595,
                2597,
                2603,
                2606,
                2536,
                2561,
                2578,
                2582,
                2475,
                2509,
                2531,
                2539,
                2541,
                2545,
                2550,
                2571,
                2576,
                2311,
                2400,
                2461,
                2469,
                2473,
                2482,
                2495,
                2507,
                2524,
                2532,
                2567,
                1972,
                2307,
                2342,
                2357,
                2358,
                2368,
                2372,
                2377,
                2381,
                2391,
                2392,
                2275,
                2338,
                1970,
                2191,
                2197,
                2203,
                2222,
                2224,
                2240,
                2250,
                2255,
                2257,
                2258,
                2259,
                2316,
                2317,
                2329,
                2332,
                1897,
                2306,
                1927,
                1990,
                2212,
                1999,
                2013,
                2026,
                2085,
                2086,
                1891,
                1971,
                1989,
                2016,
                2030,
                2044,
                2077,
                2068,
                2109,
                2096,
                2025,
                2038,
                2088,
                2124,
                2122,
                2133,
                2073,
                2105,
                2115,
                1937,
                2014,
                2015,
                2125,
                2128,
                2129,
                2131,
                2138,
                2146,
                2149,
                2165,
                2166,
                1993,
                1997,
                2027,
                2140,
                2153,
                2154,
                1968,
                1978,
                1783,
                1814,
                1836,
                1854,
                1867,
                1871,
                1903,
                1904,
                1907,
                1915,
                1926,
                1929,
                1919,
                1788,
                1792,
                1794,
                1799,
                1842,
                1847,
                1477,
                1478,
                1481,
                1483,
                1485,
                1486,
                1490,
                1493,
                1494,
                1495,
                1498,
                1499,
                1500,
                1503,
                1504,
                1508,
                1520,
                1521,
                1432,
                1452,
                1461,
                1469,
                1525,
                1541,
                1569,
                1547,
                1431,
                1589,
                1473,
                1585,
                1434,
                1537,
                1619,
                1608,
                1641,
                1573,
                1576,
                1614,
                1654,
                1672,
                1674,
                1679,
                1695,
                1665,
                1696,
                1710,
                1713,
                1733,
                1738,
                1707,
                1725,
                1727,
                1731,
                1748,
                1770,
                1690,
                1699,
                1704,
                1708,
                1717,
                1726,
                1647,
                1642,
                1656,
                1666,
                1667,
                1462,
                1441,
                1445,
                1447,
                1453,
                1458,
                1464,
                1526,
                1531,
                1536,
                1555,
                1558,
                1560,
                1578,
                1131,
                1039,
                1048,
                1057,
                1060,
                1061,
                1062,
                1064,
                1078,
                1084,
                1118,
                1123,
                1126,
                1128,
                1044,
                1068,
                1073,
                1083,
                1108,
                1215,
                1217,
                1165,
                1193,
                1247,
                1251,
                1261,
                1252,
                1275,
                1192,
                1263,
                1265,
                1273,
                1257,
                1322,
                1339,
                1280,
                1297,
                1321,
                1354,
                1358,
                1311,
                1082,
                1378,
                1133,
                1235,
                1344,
                1349,
                1382,
                1384,
                1385,
                1289,
                1295,
                1326,
                1345,
                1380,
                1396,
                1398,
                1402,
                1323,
                1391,
                1343,
                1347,
                1355,
                1366,
                1372,
                1393,
                1405,
                1412,
                1414,
                1418,
                1419,
                1420,
                1423,
                1424,
                1058,
                1266,
                1285,
                1292,
                1314,
                1195,
                1197,
                1243,
                1041,
                1076,
                1110,
                1111,
                1135,
                1148,
                1157,
                1160,
                1173,
                1176,
                1184,
                1212,
                1223,
                1227,
                1231,
                1043,
                1233,
                1140,
                1244,
                4,
                10,
                11,
                29,
                33,
                48,
                49,
                50,
                92,
                221,
                0,
                8,
                18,
                28,
                139,
                168,
                169,
                173,
                176,
                179,
                188,
                196,
                198,
                600,
                607,
                611,
                615,
                618,
                625,
                631,
                635,
                644,
                646,
                650,
                654,
                702,
                703,
                723,
                729,
                740,
                751,
                706,
                752,
                756,
                686,
                739,
                765,
                777,
                788,
                791,
                793,
                783,
                722,
                801,
                803,
                807,
                815,
                817,
                836,
                859,
                863,
                893,
                895,
                898,
                855,
                937,
                941,
                924,
                914,
                918,
                967,
                975,
                981,
                910,
                923,
                1009,
                1020,
                866,
                920,
                976,
                985,
                986,
                992,
                995,
                1003,
                1005,
                1012,
                1016,
                1018,
                1023,
                1025,
                933,
                936,
                971,
                974,
                795,
                835,
                872,
                880,
                899,
                902,
                904,
                917,
                943,
                944,
                790,
                797,
                813,
                816,
                847,
                854,
                858,
                772,
                794,
                805,
                832,
                727,
                733,
                758,
                770,
                657,
                662,
                665,
                668,
                670,
                675,
                676,
                677,
                679,
                682,
                159,
                146,
                162,
                237,
                397,
                409,
                417,
                157,
                294,
                320,
                333,
                352,
                422,
                431,
                386,
                450,
                462,
                463,
                465,
                506,
                426,
                492,
                494,
                377,
                479,
                487,
                511,
                524,
                525,
                543,
                564,
                566,
                567,
                571,
                572,
                576,
                577,
                592,
                594,
                599,
                508,
                574,
                391,
                489,
                495,
                503,
                523,
                529,
                544,
                553,
                559,
                561,
                388,
                534,
                480,
                497,
                366,
                371,
                449,
                474,
                482,
                483,
                200,
                286,
                374,
                469,
                367,
                325,
                364,
                382,
                385,
                435,
                153,
                271,
                275,
                288,
                293,
                296,
                351,
                361,
                362,
                363,
                384,
                390,
                393,
                395,
                425,
                154,
                167,
                278,
                298,
                299,
                312,
                334,
                331,
                332,
                342,
                147,
                239,
                241,
                246,
                251,
                253,
                94,
                105,
                115,
                116,
                122,
                124,
                128,
                131,
                135,
                60,
                62,
                63,
                64,
                65,
                78,
                80,
                83,
                85,
                87,
                89,
                90,
            ],
            [2435, 2406, 2534, 2266, 1152, 1213, 183, 785, 260, 464, 436, 280, 93],
            [
                1943,
                2632,
                2859,
                2788,
                2684,
                2349,
                2610,
                2612,
                1885,
                1594,
                1680,
                1096,
                1271,
                991,
                732,
                582,
                575,
                263,
                327,
                429,
                98,
                86,
            ],
        ]
    )
    assert output_med[:5, :5].tolist() == snapshot(
        [
            [13, 88, 95, 198, 249],
            [43, 246, 40, 153, 77],
            [120, 30, 49, 212, 24],
            [134, 93, 118, 102, 210],
            [247, 128, 177, 211, 238],
        ]
    )
